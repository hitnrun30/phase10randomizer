# Phase 10 Randomizer Web App

This repo hosts a Phase 10 randomizer web app with:

* A PHP front-end that renders the page and calls a Python backend.
* A Python backend (Flask) that generates and ranks Phase 10 phases.
* A shared `phase10config.json` so you can tune things like Monte Carlo trials, phase constraints, and timeouts from the UI.

It’s designed to run:

* In dev on a single Windows box with PHP’s built-in server and a local Flask server.
* In prod on a Synology NAS using Docker, with:

  * `nginx` as the edge reverse proxy (separate container).
  * `php-fpm` for the PHP front-end.
  * `py-app` for the Python backend (gunicorn + Flask), all sharing `/volume1/docker/www`.

---

## Directory layout

Typical project layout (dev or inside `/volume1/docker/www/phase10` on the NAS):

```text
phase10/
  index.php
  main.css
  python_client.php
  phase10_html.py
  phase10_service.py
  phase10config.py
  phase10config.json
  phase10logic.py
  phase10probability.py
  phase10typelogic.py
  requirements.txt
  images/
    phase10icon.png
    phase10logo.png
```

* `index.php` – main web page and settings UI (gear icon).
* `main.css` – styling for the page and settings panel.
* `python_client.php` – generic HTTP client that talks to the Python backend.
* `phase10_html.py` – engine script that imports the Phase 10 logic and prints a `<li>…</li>` list of phases to stdout.
* `phase10_service.py` – Flask app providing `/health` and `/phase10/html`. Handles config updates, timeouts, and runs `phase10_html.py` as a subprocess.
* `phase10config.py` / `phase10config.json` – default config plus persisted config values.
* `phase10logic.py`, `phase10probability.py`, `phase10typelogic.py` – game logic and probability engine.
* `requirements.txt` – Python dependencies (Flask, gunicorn, and engine libraries).
* `images/phase10icon.png` – small icon used in the UI.
* `images/phase10logo.png` – logo used on the main page.

---

## Development setup (Windows)

### 1. Python environment

From the project folder:

```bash
python -m venv .venv
.\.venv\Scripts\activate
pip install --upgrade pip
pip install -r requirements.txt
```

### 2. Start the Python backend

Run the Flask service locally:

```bash
.\.venv\Scripts\activate
python phase10_service.py
```

This starts a dev server on:

```text
http://127.0.0.1:5001
```

`phase10_service.py` exposes:

* `GET /health` – simple JSON health check.
* `GET /phase10/html?...` – returns `<li>…</li>` items generated by `phase10_html.py`. It reads `phase10config.json` via `phase10config.CONFIG`, applies overrides from query parameters, writes `phase10config.json` back out so UI changes persist, and runs `phase10_html.py` as a subprocess with a hard timeout (`HTML_TIMEOUT_SECONDS`).

### 3. Start the PHP front-end

Use PHP’s built-in dev server from the same folder:

```bash
php -S localhost:8000 -t .
```

Then open:

```text
http://localhost:8000/
```

in your browser.

`python_client.php` automatically detects dev vs prod:

* On `localhost` / `127.0.0.1`, it defaults to `http://127.0.0.1:5001` for the Python backend.
* `index.php` uses `callPython('/phase10/html?...', $curlTimeout, 'PHASE10_BASE_URL')`. In dev, you usually do not define `PHASE10_BASE_URL`; it falls back to `127.0.0.1:5001`.

---

## Config and settings

Configuration is stored in `phase10config.json` and mirrored in `phase10config.CONFIG`. The UI gear in the upper right lets you change these at runtime; `phase10_service.py` merges query parameters with defaults and writes the updated config to JSON on each request.

Config keys and what they do:

* `MC_TRIALS_DEFAULT` – default number of Monte Carlo trials used when estimating phase probabilities. Higher is more accurate but slower.
* `PHASE_PROB_CACHE` – cache structure for phase probability results. In the JSON file this is kept as an empty object; the live cache is maintained in memory.
* `COLOR_RAND` – relative weighting for colored cards when randomizing phases. Larger values bias phases toward color-based requirements.
* `WILD_RAND` – relative weighting for wild cards when randomizing phases. Larger values bias phases toward wild-heavy phases.
* `TYPE_MAX_PER_PHASE` – maximum number of distinct phase “types” allowed in a single phase. This limits how complex any one phase can be.
* `USE_MONTE_CARLO` – when `true`, the probability engine uses Monte Carlo simulation; when `false`, it uses a cheaper deterministic estimate.
* `SHOW_PHASE_PROBABILITY` – when `true`, the UI shows the estimated probability alongside each phase; when `false`, it hides the probability display.
* `MIN_CARDS_PER_PHASE` – minimum number of cards required in a phase; phases below this size are not generated.
* `TYPE_MAX_PER_TYPE_GLOBAL` – maximum number of times a given phase type can appear globally across the full 10-phase set; helps avoid repeating the same type too often.
* `HTML_TIMEOUT_SECONDS` – maximum time allowed (in seconds) for the backend to run `phase10_html.py` before it terminates the subprocess and returns a timeout message.

On each request, `phase10_service.py`:

1. Starts from `phase10config.CONFIG` (defaults + last saved JSON).
2. Applies overrides from the query string (values chosen in the UI).
3. Writes the merged config back into `phase10config.json` so it persists.
4. Runs `phase10_html.py` with a subprocess timeout equal to `HTML_TIMEOUT_SECONDS`.

If Monte Carlo is enabled, performance is primarily governed by `MC_TRIALS_DEFAULT`, `HTML_TIMEOUT_SECONDS`, and the complexity bounds (`TYPE_MAX_PER_PHASE`, `TYPE_MAX_PER_TYPE_GLOBAL`).

---

## Production setup (Synology + Docker)

### 1. Shared code volume

On the NAS, place the project under:

```text
/volume1/docker/www/phase10
```

This folder will be mounted into the Python container at:

```text
/www/phase10
```

so changes in the repo land in the container without rebuilding the image.

### 2. Python backend container (`py-app`)

The Python container image is generic; the app code lives in the mounted `/www` volume.

#### `wsgi.py` (inside the image)

In `/volume1/docker/pyapp/wsgi.py`:

```python
import os
import sys

APP_DIR = os.environ.get("APP_DIR", "/www/phase10")
if APP_DIR not in sys.path:
    sys.path.insert(0, APP_DIR)

from phase10_service import app  # gunicorn will use "wsgi:app"
```

#### Dockerfile snippet

In `/volume1/docker/pyapp/Dockerfile`:

```dockerfile
FROM python:alpine

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    TZ=America/New_York

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY wsgi.py /app/wsgi.py

EXPOSE 8000

CMD ["gunicorn", "--bind", "0.0.0.0:8000", "wsgi:app", "--workers=1", "--threads=1", "--timeout=60"]
```

#### `docker-compose.yml` snippet for `py-app`

Under `/volume1/docker/pyapp/docker-compose.yml`:

```yaml
services:
  pyapp:
    build:
      context: /volume1/docker/pyapp
      dockerfile: Dockerfile
    image: local/python-app:latest
    container_name: py-app
    restart: unless-stopped
    environment:
      - TZ=America/New_York
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - APP_DIR=/www/phase10
    expose:
      - "8000"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    volumes:
      - /volume1/docker/www:/www
    networks:
      apps:
        aliases:
          - py

networks:
  apps:
    external: true
    name: apps
```

Key points:

* The entire `/volume1/docker/www` tree is mounted read/write at `/www`.
* `APP_DIR=/www/phase10` tells `wsgi.py` which project folder to use.
* `py` is the Docker DNS alias used by PHP (`http://py:8000`).

### 3. PHP container (php-fpm) snippet

The PHP container needs the web root mounted and an environment variable pointing to the Python backend.

Example snippet for the `php-fpm` service:

```yaml
services:
  php:
    image: php:fpm-alpine
    container_name: php-fpm
    restart: unless-stopped
    environment:
      - TZ=America/New_York
      - PHASE10_BASE_URL=http://py:8000
    volumes:
      - /volume1/docker/nginx/html:/var/www/html
    networks:
      apps: {}
```

`python_client.php` is generic; Phase 10’s `index.php` uses:

```php
$html = callPython($path, $curlTimeout, 'PHASE10_BASE_URL');
```

which resolves to `http://py:8000/phase10/html?...` inside the Docker network.

### 4. Nginx (edge) snippet

The `nginx-edge` container proxies incoming HTTPS/HTTP to PHP. A minimal server block for the Phase 10 site looks like:

```nginx
upstream php-fpm {
    server php-fpm:9000;
}

server {
    listen 443 ssl http2;
    server_name phase10.example.com;

    root /var/www/html/phase10;
    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass php-fpm;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # ssl_certificate /etc/ssl/private/fullchain.pem;
    # ssl_certificate_key /etc/ssl/private/privkey.pem;
}
```

Adjust `root`, `server_name`, and TLS paths to match your environment.

---

## Tuning Monte Carlo and performance

On the NAS, Monte Carlo performance is primarily controlled by:

* `USE_MONTE_CARLO` – enable or disable MC.
* `MC_TRIALS_DEFAULT` – higher values are more accurate but slower.
* `HTML_TIMEOUT_SECONDS` – hard time limit for each phase generation run.
* `TYPE_MAX_PER_PHASE` and `TYPE_MAX_PER_TYPE_GLOBAL` – constrain how complex phases can be and how often types repeat.

A reasonable starting point for production might be:

* `USE_MONTE_CARLO: true`
* `MC_TRIALS_DEFAULT: 1000–1500`
* `TYPE_MAX_PER_PHASE: 3`
* `TYPE_MAX_PER_TYPE_GLOBAL: 3`
* `HTML_TIMEOUT_SECONDS: 8–12`

The UI gear writes these settings back to `phase10config.json`, and each request uses the latest values.

---

## License

This project is intended to be licensed under the MIT License (a copy should be included in `LICENSE` in the root of the repository). If you choose to use a different license, update this section and the `LICENSE` file accordingly.

In short (if using MIT):

> Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the “Software”), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, subject to the conditions described in the full MIT License text.

Always consult the full license text in `LICENSE` for the exact terms.

---

## Trademarks

* Phase 10 is a registered trademark of Mattel, Inc. This project is an independent, fan-made tool and is not endorsed by, affiliated with, or sponsored by Mattel.
* Python is a trademark of the Python Software Foundation.
* PHP is a trademark of The PHP Group.
* Docker is a trademark of Docker, Inc.
* Synology is a trademark of Synology Inc.
* All other product names, logos, and brands are property of their respective owners and used here for identification purposes only.
